cmake_minimum_required (VERSION 3.8)
set(NAME telex)
project (${NAME})

if(NOT EXISTS ${TELEX_DIR})
    if(EXISTS $ENV{TELEX_DIR})
        set(TELEX_DIR $ENV{TELEX_DIR})
    else()
        if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/scripts)
            set(TELEX_DIR ${CMAKE_CURRENT_SOURCE_DIR})
        else()
            message(FATAL_ERROR "TELEX_DIR is not set neither TELEX_DIR Environment variable is not pointing to Telex dir")
        endif()
    endif()
endif()

if(NOT WIN32)
    set(CMAKE_CXX_FLAGS "-Wall -Wextra ${CMAKE_CXX_FLAGS}")
else()
    set(CMAKE_CXX_FLAGS "-DWINDOWS_OS ${CMAKE_CXX_FLAGS}")
    add_compile_options(-D_WIN32)
    add_compile_options(-DWINDOWS_OS)
    add_compile_options(-DLIBUS_NO_SSL)
    add_compile_options(-DNOMINMAX)
endif()
if(APPLE)
    set(CMAKE_CXX_FLAGS "-DMAC_OS ${CMAKE_CXX_FLAGS}")
elseif(UNIX)
   set(CMAKE_CXX_FLAGS "-DUNIX_OS ${CMAKE_CXX_FLAGS}")
   set(CMAKE_POSITION_INDEPENDENT_CODE ON)
   add_compile_options(-fPIC)
endif()


add_subdirectory(telexlib)
add_subdirectory(affiliates)
add_subdirectory(test)
add_subdirectory(blog)
add_subdirectory(apps)

if(EXISTS $ENV{MDMAKER})
    set(MARKDOWNMAKER $ENV{MDMAKER})
else()
    find_program (MARKDOWNMAKER mdmaker)
endif()

if(EXISTS ${MARKDOWNMAKER})
    FILE(GLOB README_FILES "telexlib/include/*.h")
    foreach(FILE ${README_FILES})
        get_filename_component(BASE_NAME ${FILE} NAME_WE)
        add_custom_target("${BASE_NAME}_readme"
            COMMAND ${MARKDOWNMAKER} ${FILE} -o ${CMAKE_CURRENT_SOURCE_DIR}/${BASE_NAME}.md
            DEPENDS ${FILE})
        add_dependencies(${NAME} "${BASE_NAME}_readme")
    endforeach()
else()
    message("mdmaker not found (install in path or set MDMAKER env), cannot generate documentation")
endif()

